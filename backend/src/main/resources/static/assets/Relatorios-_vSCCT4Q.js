import{r as c,j as a}from"./react-vendor-CQulTfZ0.js";import{u as Se,g as k,S as te,f as xe,b as Ne}from"./index-Cs2E90Ho.js";import{F as Ce}from"./formasPagamento-DCNrKZWd.js";import{m as Ae,a as Oe}from"./validacao-D9FFwnBf.js";import"./router-MSaW0Gl8.js";import"./axios-D5GkNzM3.js";const S=[{id:"grupos",label:"Grupos",category:"Cadastrais",endpoint:"/relatorios/cadastrais/grupos"},{id:"instrumentos",label:"Instrumentos",category:"Cadastrais",endpoint:"/relatorios/cadastrais/instrumentos",params:[{name:"grupoId",label:"Grupo",type:"select-search",optionsSearchUrl:"/grupos",placeholderFirst:{value:"",label:"Todos"},compact:!0}]},{id:"alunos",label:"Alunos",category:"Cadastrais",endpoint:"/relatorios/cadastrais/alunos",params:[{name:"ativo",label:"Ativo",type:"select",optionsKey:"simnao"},{name:"instrumentoId",label:"Instrumento",type:"select-search",optionsSearchUrl:"/relatorios/cadastrais/instrumentos-turmas",placeholderFirst:{value:"",label:"Todos"}}]},{id:"professores",label:"Professores",category:"Cadastrais",endpoint:"/relatorios/cadastrais/professores",params:[{name:"ativo",label:"Ativo",type:"select",optionsKey:"simnao"}]},{id:"usuarios",label:"Usuários",category:"Cadastrais",endpoint:"/relatorios/cadastrais/usuarios",params:[{name:"perfil",label:"Perfil",type:"select",optionsKey:"perfil"}]},{id:"turmas",label:"Turmas",category:"Cadastrais",endpoint:"/relatorios/cadastrais/turmas",params:[{name:"ativo",label:"Ativo",type:"select",optionsKey:"simnao"},{name:"instrumentoId",label:"Instrumento",type:"select-search",optionsSearchUrl:"/instrumentos",placeholderFirst:{value:"",label:"Todos"}},{name:"professorId",label:"Professor",type:"select-search",optionsSearchUrl:"/professores",placeholderFirst:{value:"",label:"Todos"}}]},{id:"matriculas",label:"Matrículas",category:"Matrículas",endpoint:"/relatorios/matriculas",params:[{name:"ativo",label:"Ativo",type:"select",optionsKey:"simnao"},{name:"alunoId",label:"Aluno",type:"select-search",optionsSearchUrl:"/alunos",placeholderFirst:{value:"",label:"Todos"}},{name:"dataInicio",label:"Data início",type:"date"},{name:"dataFim",label:"Data fim",type:"date"}]},{id:"mensalidades",label:"Mensalidades",category:"Financeiro",endpoint:"/relatorios/mensalidades",params:[{name:"ano",label:"Ano",type:"number"},{name:"mes",label:"Mês",type:"number"},{name:"status",label:"Status",type:"select",optionsKey:"statusMensalidade"},{name:"alunoId",label:"Aluno",type:"select-search",optionsSearchUrl:"/alunos",placeholderFirst:{value:"",label:"Todos"}}]},{id:"inadimplencia",label:"Inadimplência",category:"Financeiro",endpoint:"/relatorios/inadimplencia",params:[{name:"ano",label:"Ano",type:"number"},{name:"mes",label:"Mês",type:"number"}]},{id:"receita",label:"Receita realizada",category:"Financeiro",endpoint:"/relatorios/receita",params:[{name:"dataInicio",label:"Data início",type:"date"},{name:"dataFim",label:"Data fim",type:"date"},{name:"formaPagamento",label:"Forma de pagamento",type:"select",optionsKey:"formasPagamento",placeholderFirst:{value:"",label:"Todos"}}]},{id:"presenca-alunos",label:"Presença (alunos)",category:"Presença",endpoint:"/relatorios/presenca-alunos",params:[{name:"alunoId",label:"Aluno",type:"select-search",optionsSearchUrl:"/alunos",placeholderFirst:{value:"",label:"Todos"}},{name:"dataInicio",label:"Data início",type:"date"},{name:"dataFim",label:"Data fim",type:"date"}]},{id:"presenca-professores",label:"Presença (professores)",category:"Presença",endpoint:"/relatorios/presenca-professores",params:[{name:"professorId",label:"Professor",type:"select-search",optionsSearchUrl:"/professores",placeholderFirst:{value:"",label:"Todos"}},{name:"dataInicio",label:"Data início",type:"date"},{name:"dataFim",label:"Data fim",type:"date"}]},{id:"dashboard",label:"Consolidado (dashboard)",category:"Consolidado",endpoint:"/relatorios/consolidado/dashboard",isObject:!0},{id:"auditoria",label:"Auditoria",category:"Auditoria",endpoint:"/relatorios/auditoria",params:[{name:"usuarioId",label:"ID usuário",type:"number"},{name:"tabela",label:"Tabela",type:"text"},{name:"acao",label:"Ação",type:"select",optionsKey:"acaoAuditoria"},{name:"dataInicio",label:"Data/hora início",type:"datetime"},{name:"dataFim",label:"Data/hora fim",type:"datetime"}]},{id:"erros",label:"Erros",category:"Erros",endpoint:"/relatorios/erros",params:[{name:"dataInicio",label:"Data/hora início",type:"datetime"},{name:"dataFim",label:"Data/hora fim",type:"datetime"}]}],oe=[{value:"",label:"Todos"},{value:"true",label:"Sim"},{value:"false",label:"Não"}],re=[{value:"",label:"Todos"},{value:"PENDENTE",label:"Pendente"},{value:"PAGO",label:"Pago"},{value:"ATRASADO",label:"Atrasado"}],Re=[{value:"",label:"Todas"},{value:"CONSULTAR",label:"Consultar"},{value:"CRIAR",label:"Criar"},{value:"ATUALIZAR",label:"Atualizar"},{value:"EXCLUIR",label:"Excluir"}],Ee=[{value:"",label:"Todos"},...Ce.map(n=>({value:n,label:n}))],Te=S.map(n=>({value:n.id,label:n.label}));function $e(){var ae;const{t:n,i18n:se}=Se(),[d,le]=c.useState(S[0].id),[h,f]=c.useState({}),[x,ne]=c.useState({}),[p,N]=c.useState(null),[D,U]=c.useState(!1),[$,w]=c.useState(""),[R,C]=c.useState(null),[L,E]=c.useState(null),[K,M]=c.useState({}),[_,T]=c.useState({}),[ie,g]=c.useState({}),[ce,B]=c.useState({}),[de,F]=c.useState({}),P=c.useRef(null),u=S.find(e=>e.id===d)??S[0],me=!u.isObject,G=[{value:"",label:"Todos"},{value:"ADMINISTRADOR",label:n("usuarios.profileAdmin").toUpperCase()},{value:"PROFESSOR",label:n("usuarios.profileProfessor").toUpperCase()},{value:"FUNCIONARIO",label:n("usuarios.profileFuncionario").toUpperCase()}],ue=c.useCallback(async e=>{if(e.optionsKey==="simnao")return oe;if(e.optionsKey==="perfil")return G;if(e.optionsKey==="statusMensalidade")return re;if(!e.optionsUrl)return[];const o=e.optionsUrl;if(x[o])return x[o];const t=await k().get(o),s=e.optionsKey==="content"?t.data.content:t.data,m=(Array.isArray(s)?s:[]).map(b=>{const i=b,v=i.id,O=i.nome??(i.instrumentoNome&&i.professorNome?`${i.instrumentoNome} - ${i.professorNome}`:i.instrumentoNome??i.professorNome)??v,je=typeof O=="string"?O:String(v);return{value:String(v),label:je||String(v)}}),y=e.optionsKey==="content"?[{value:"",label:"Todos"},...m]:m;return ne(b=>({...b,[o]:y})),y},[x,n]);c.useEffect(()=>{N(null),f({}),M({}),T({}),g({}),F({})},[d]);const V=c.useCallback(async(e,o)=>{if(!e.optionsSearchUrl)return;const r=e.name;B(t=>({...t,[r]:!0}));try{const l=(await k().get(e.optionsSearchUrl,{params:{busca:o||void 0,size:20,page:0}})).data,m=Array.isArray(l)?l:l.content??[];let y=(Array.isArray(m)?m:[]).map(b=>{const i=b,v=i.id,O=i.nome??(i.instrumentoNome&&i.professorNome?`${i.instrumentoNome} - ${i.professorNome}`:null)??String(v);return{value:String(v),label:String(O)}});if(o&&o.trim()){const b=o.trim().toLowerCase();y=y.filter(i=>i.label.toLowerCase().includes(b))}T(b=>({...b,[r]:y}))}catch{T(t=>({...t,[r]:[]}))}finally{B(t=>({...t,[r]:!1}))}},[]),z=c.useCallback((e,o,r)=>{const t=e.name;f(s=>({...s,[t]:o})),F(s=>({...s,[t]:o?r:""})),g(s=>({...s,[t]:!1}))},[]),pe=e=>{if(e.optionsKey==="simnao")return oe;if(e.optionsKey==="perfil")return G;if(e.optionsKey==="statusMensalidade")return re;if(e.optionsKey==="acaoAuditoria")return Re;if(e.optionsKey==="formasPagamento")return Ee;const o=e.optionsUrl??e.optionsKey??"",r=x[o]??[];return e.placeholderFirst?[e.placeholderFirst,...r]:r};c.useEffect(()=>{var e;(e=u.params)==null||e.forEach(o=>{o.optionsUrl&&o.type!=="select-search"&&ue(o).catch(()=>{})})},[d]);function be(){var o;const e={};return(o=u.params)==null||o.forEach(r=>{var s;let t=(s=h[r.name])==null?void 0:s.trim();t===void 0||t===""||(r.type==="datetime"&&t&&(t=t.replace("T","T").replace("Z",""),t.includes(".")||(t=t+":00")),e[r.name]=t)}),e}async function he(){var e;w(""),U(!0);try{const o=be(),r=new URLSearchParams(o).toString(),t=r?`${u.endpoint}?${r}`:u.endpoint,s=await k().get(t);u.isObject?N(s.data):N(Array.isArray(s.data)?s.data:[])}catch(o){N(null);const r=o&&typeof o=="object"&&"response"in o?o.response:void 0,t=r==null?void 0:r.status,s=(e=r==null?void 0:r.data)==null?void 0:e.mensagem;w(t===403?n("relatorios.erroSemPermissao"):s&&s.trim()?s:"Erro ao gerar relatório.")}finally{U(!1)}}function H(){if(!p)return;if(u.isObject){const y=`Campo;Valor
`+Object.entries(p).map(([b,i])=>`${b};${i}`).join(`
`);q(y,`relatorio-${u.id}.csv`);return}const e=p;if(e.length===0)return;const o=d==="presenca-alunos"?Q.filter(l=>Object.prototype.hasOwnProperty.call(e[0],l)):d==="presenca-professores"?W.filter(l=>Object.prototype.hasOwnProperty.call(e[0],l)):d==="receita"?X.filter(l=>Object.prototype.hasOwnProperty.call(e[0],l)):d==="erros"?J.filter(l=>Object.prototype.hasOwnProperty.call(e[0],l)):Object.keys(e[0]),r=o.map(l=>Z(j(l))).join(";"),t=e.map(l=>o.map(m=>Z(d==="erros"&&m==="stackTrace"?String(l[m]??""):A(l[m],m))).join(";")).join(`
`),s=r+`
`+t;q(s,`relatorio-${u.id}.csv`)}function Z(e){return/[;"\n]/.test(e)?`"${e.replace(/"/g,'""')}"`:e}function q(e,o){const r=new Blob(["\uFEFF"+e],{type:"text/csv;charset=utf-8"}),t=document.createElement("a");t.href=URL.createObjectURL(r),t.download=o,t.click(),URL.revokeObjectURL(t.href)}Array.from(new Set(S.map(e=>e.category)));function j(e){const o=`relatorios.column.${e}`,r=n(o);return r!==o?r:e.replace(/([A-Z])/g," $1").replace(/^./,t=>t.toUpperCase()).trim()}const fe=["dataNascimento","dataInicio","dataFim","vencimento","dataPagamento","dataAula"],ye=["dataHora"],ve=["cpf","responsavelCpf"];function A(e,o){if(e==null)return"";if(typeof e=="boolean")return n(e?"common.yes":"common.no");if(o==="valor"||o==="valorTotal"||o==="valorCurso"){const r=typeof e=="number"?e:typeof e=="string"&&e.trim()?Number(e):NaN;if(!Number.isNaN(r))return new Intl.NumberFormat(se.language||"pt-BR",{style:"currency",currency:"BRL"}).format(r)}return o==="telefone"&&typeof e=="string"&&e.trim()?Ae(e):fe.includes(o)&&typeof e=="string"&&e.trim()?xe(e):ye.includes(o)&&typeof e=="string"&&e.trim()?Ne(e):ve.includes(o)&&typeof e=="string"&&e.trim()?Oe(e):String(e)}const I=d==="alunos",Q=["dataAula","presente","alunoNome","turma","conteudoAula"],W=["dataAula","presente","professorNome","instrumento"],X=["dataPagamento","alunoNome","valor","formaPagamento","mesAno"],J=["id","dataHora","acao","mensagemErro","tipoExcecao","stackTrace"],Y=e=>{if(e.length===0)return[];const o=Object.keys(e[0]);return d==="presenca-alunos"?Q.filter(r=>o.includes(r)):d==="presenca-professores"?W.filter(r=>o.includes(r)):d==="receita"?X.filter(r=>o.includes(r)):d==="erros"?J.filter(r=>o.includes(r)):I?o.filter(r=>r!=="responsavelNome"&&r!=="responsavelCpf"):o},ee=100;function ge(e){return e==null||e===""?"":e.length<=ee?e:e.slice(0,ee)+"..."}return a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"page-header",children:a.jsx("h1",{children:n("relatorios.title")})}),$&&a.jsx("div",{className:"alert alert-error",children:$}),a.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[a.jsx("h2",{style:{margin:"0 0 1rem",fontSize:"1.1rem"},children:"Selecione o relatório"}),a.jsxs("div",{className:"relatorios-filters",children:[a.jsxs("div",{className:"form-group relatorios-form-group-report",children:[a.jsx("label",{htmlFor:"rel-report",children:"Relatório"}),a.jsx(te,{id:"rel-report",value:d,onChange:e=>le(e),options:Te,placeholder:"Digite para buscar o relatório...","aria-label":"Selecione o relatório"})]}),(ae=u.params)==null?void 0:ae.map(e=>{var o,r;return a.jsxs("div",{className:"form-group",children:[a.jsx("label",{htmlFor:`rel-${e.name}`,children:e.label}),e.type==="select-search"&&e.optionsSearchUrl?a.jsxs("div",{className:`relatorio-select-search${e.compact?" relatorio-select-search--compact":""}${e.name==="alunoId"?" relatorio-select-search--aluno":""}`,children:[a.jsx("input",{id:`rel-${e.name}`,type:"text",autoComplete:"off",value:h[e.name]?de[e.name]??"":K[e.name]??"",onChange:t=>{const s=t.target.value;h[e.name]&&(f(l=>({...l,[e.name]:""})),F(l=>({...l,[e.name]:""}))),M(l=>({...l,[e.name]:s})),P.current&&clearTimeout(P.current),P.current=setTimeout(()=>{g(l=>({...l,[e.name]:!0})),V(e,s).then(()=>{})},350)},onFocus:()=>{var t;g(s=>({...s,[e.name]:!0})),!((t=_[e.name])!=null&&t.length)&&!K[e.name]&&V(e,"").then(()=>{})},onBlur:()=>setTimeout(()=>g(t=>({...t,[e.name]:!1})),200),placeholder:((o=e.placeholderFirst)==null?void 0:o.label)??e.label}),ie[e.name]&&a.jsxs("ul",{className:"relatorio-select-search-dropdown",role:"listbox",children:[e.placeholderFirst&&a.jsx("li",{role:"option",onMouseDown:t=>{t.preventDefault(),z(e,e.placeholderFirst.value,e.placeholderFirst.label)},children:e.placeholderFirst.label}),ce[e.name]?a.jsx("li",{className:"relatorio-select-search-loading",children:"Carregando..."}):(_[e.name]??[]).map(t=>a.jsx("li",{role:"option",onMouseDown:s=>{s.preventDefault(),z(e,t.value,t.label)},children:t.label},t.value))]})]}):e.type==="select"?a.jsx(te,{id:`rel-${e.name}`,value:h[e.name]??"",onChange:t=>f(s=>({...s,[e.name]:t})),options:pe(e),placeholder:((r=e.placeholderFirst)==null?void 0:r.label)??`Buscar ${e.label.toLowerCase()}...`,"aria-label":e.label}):e.type==="date"?a.jsx("input",{id:`rel-${e.name}`,type:"date",value:h[e.name]??"",onChange:t=>f(s=>({...s,[e.name]:t.target.value}))}):e.type==="number"?a.jsx("input",{id:`rel-${e.name}`,type:"number",value:h[e.name]??"",onChange:t=>f(s=>({...s,[e.name]:t.target.value})),placeholder:e.name==="mes"?"1-12":e.name==="ano"?"ex: 2025":""}):e.type==="datetime"?a.jsx("input",{id:`rel-${e.name}`,type:"datetime-local",value:h[e.name]??"",onChange:t=>f(s=>({...s,[e.name]:t.target.value}))}):a.jsx("input",{id:`rel-${e.name}`,type:"text",value:h[e.name]??"",onChange:t=>f(s=>({...s,[e.name]:t.target.value})),placeholder:e.label})]},e.name)}),a.jsx("div",{className:"form-group",style:{alignSelf:"flex-end"},children:a.jsx("button",{type:"button",className:"btn btn-primary",onClick:he,disabled:D,children:D?"Gerando...":"Gerar"})})]})]}),p!==null&&a.jsxs("div",{className:"card",children:[a.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"1rem",flexWrap:"wrap",gap:"0.5rem"},children:[a.jsx("h2",{style:{margin:0,fontSize:"1.1rem"},children:u.label}),me?a.jsx("button",{type:"button",className:"btn btn-outline",onClick:H,children:"Exportar CSV"}):a.jsx("button",{type:"button",className:"btn btn-outline",onClick:H,children:"Exportar CSV"})]}),u.isObject?a.jsxs("dl",{className:"relatorio-object relatorio-object--query",style:{"--cols":Object.keys(p).length},children:[Object.entries(p).map(([e])=>a.jsx("span",{className:"relatorio-object-label",children:j(e)},`label-${e}`)),Object.entries(p).map(([e,o])=>a.jsx("span",{className:"relatorio-object-value",children:String(o)},`value-${e}`))]}):a.jsx(a.Fragment,{children:p.length===0?a.jsx("p",{className:"empty-state",children:n("relatorios.noRecordFound")}):a.jsx("div",{className:"table-wrap",children:a.jsxs("table",{children:[a.jsx("thead",{children:a.jsx("tr",{children:Y(p).map(e=>a.jsx("th",{children:j(e)},e))})}),a.jsx("tbody",{children:p.map((e,o)=>a.jsx("tr",{children:Y(p).map(r=>{const t=e[r],s=I&&(e.responsavelNome||e.responsavelCpf);if(I&&r==="cpf"&&s)return a.jsx("td",{className:"celula-valor-clicavel",onClick:()=>C(e),role:"button",tabIndex:0,onKeyDown:l=>(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),C(e)),children:a.jsx("span",{className:"celula-valor-ver-calculo",children:n("relatorios.clickToSeeResponsavel")})},r);if(d==="erros"&&r==="stackTrace"){const l=typeof t=="string"?t:String(t??"");if(!l.trim())return a.jsx("td",{children:"—"},r);const m=ge(l);return a.jsx("td",{children:a.jsx("button",{type:"button",className:"link-stack-trace",onClick:()=>E(l),children:m})},r)}return a.jsx("td",{children:A(t,r)},r)})},o))})]})})})]}),R!=null&&a.jsx("div",{className:"modal-overlay",onClick:()=>C(null),children:a.jsxs("div",{className:"modal modal-responsavel",onClick:e=>e.stopPropagation(),children:[a.jsx("div",{className:"modal-header",children:a.jsx("h2",{children:n("relatorios.infoResponsavel")})}),a.jsx("div",{className:"modal-body",children:a.jsxs("dl",{className:"relatorio-object",children:[a.jsxs("div",{children:[a.jsx("dt",{children:j("responsavelNome")}),a.jsx("dd",{children:A(R.responsavelNome,"responsavelNome")||"—"})]}),a.jsxs("div",{children:[a.jsx("dt",{children:j("responsavelCpf")}),a.jsx("dd",{children:A(R.responsavelCpf,"responsavelCpf")||"—"})]})]})}),a.jsx("div",{className:"modal-footer",children:a.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>C(null),children:n("common.close")})})]})}),L!=null&&a.jsx("div",{className:"modal-overlay",onClick:()=>E(null),children:a.jsxs("div",{className:"modal modal-stack-trace",onClick:e=>e.stopPropagation(),children:[a.jsx("div",{className:"modal-header",children:a.jsx("h2",{children:n("relatorios.column.stackTrace")})}),a.jsx("div",{className:"modal-body",children:a.jsx("pre",{className:"stack-trace-content",children:L})}),a.jsx("div",{className:"modal-footer",children:a.jsx("button",{type:"button",className:"btn btn-primary",onClick:()=>E(null),children:n("common.close")})})]})})]})}export{$e as default};
