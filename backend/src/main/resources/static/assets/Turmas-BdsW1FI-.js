import{r as n,j as e}from"./react-vendor-CQulTfZ0.js";import{u as ae,g as w,S as le,a as ue,P as me}from"./index-Cs2E90Ho.js";import{g as he}from"./apiErrors-CU3vO3iu.js";import{M as pe}from"./ModalConfirm-BN9a4XRF.js";import"./router-MSaW0Gl8.js";import"./axios-D5GkNzM3.js";const fe=[{value:1,label:"Segunda"},{value:2,label:"Terça"},{value:3,label:"Quarta"},{value:4,label:"Quinta"},{value:5,label:"Sexta"}],ge={Segunda:1,Terça:2,Quarta:3,Quinta:4,Sexta:5};function xe(a){if(!a||!a.trim())return[];const l=[],i=a.split(",").map(r=>r.trim()).filter(Boolean);for(const r of i){const c=r.match(/^(\d+)-(\d{1,2}:\d{2})-(\d{1,2}:\d{2})$/);if(c){l.push({diaSemana:Number(c[1]),horario:`${c[2]}-${c[3]}`});continue}const b=r.match(/^(\d+)-(\d{1,2}:\d{2})$/);if(b){const N=b[2],[p]=N.split(":").map(Number),S=`${String(p+1).padStart(2,"0")}:00`;l.push({diaSemana:Number(b[1]),horario:`${N}-${S}`});continue}const h=r.match(/^(Segunda|Terça|Quarta|Quinta|Sexta)\s+(\d{1,2})h(?:\d{2})?$/i);if(h){const N=h[1].charAt(0).toUpperCase()+h[1].slice(1).toLowerCase(),p=ge[N];if(p!=null){const S=h[2].padStart(2,"0"),g=`${String(parseInt(S,10)+1).padStart(2,"0")}:00`;l.push({diaSemana:p,horario:`${S}:00-${g}`})}}}return l}function _(a){return a.includes("-")?a.split("-")[0]:a}function je(a){if(a.includes("-")){const l=a.split("-");return l[l.length-1]||""}return""}function Se(a){const l=fe.find(r=>r.value===a.diaSemana),i=l?l.label:`Dia ${a.diaSemana}`;if(a.horario.includes("-")){const[r,c]=a.horario.split("-");return`${i} - ${r.replace(":","h")} às ${c.replace(":","h")}`}return`${i} - ${a.horario.replace(":","h")}`}function ce(a){return`${a.diaSemana}-${_(a.horario)}`}function be({turma:a,onFechar:l,onSalvo:i}){const{t:r}=ae(),[c,b]=n.useState([]),[h,N]=n.useState(""),[p,S]=n.useState(""),[g,v]=n.useState(""),[x,D]=n.useState(""),[L,F]=n.useState(!0),[k,M]=n.useState([]),[I,O]=n.useState([]),[d,f]=n.useState(null),[m,j]=n.useState(""),[H,Q]=n.useState(!1),[$,q]=n.useState(!1),[V,G]=n.useState(""),[R,B]=n.useState(!1),E=!!(a!=null&&a.id);n.useEffect(()=>{w().get("/professores/ativos").then(s=>O(s.data))},[]),n.useEffect(()=>{if(!x){f(null);return}const s=Number(x),o=I.find(u=>u.id===s);if((o==null?void 0:o.disponibilidade)!=null&&o.disponibilidade.trim()!==""){f(o);return}w().get(`/professores/${s}`).then(u=>f(u.data)).catch(()=>f(o??null))},[x,I]),n.useEffect(()=>{if(!p){M([]),v("");return}w().get("/instrumentos/ativos",{params:{grupoId:p}}).then(s=>{M(s.data),v(o=>s.data.some(A=>A.id===o)?o:"")}).catch(()=>M([]))},[p]);const K=s=>{S(s),v("")},J=s=>{v(s||"")},T=n.useMemo(()=>{if(!g)return"";const s=k.find(o=>o.id===Number(g));return(s==null?void 0:s.nome)??""},[g,k]),t=n.useMemo(()=>T.trim()?I.filter(s=>(s.instrumentos??"").split(",").map(u=>u.trim()).filter(Boolean).some(u=>u.toLowerCase()===T.toLowerCase())):[],[I,T]),P=n.useMemo(()=>{const s=V.trim().toLowerCase();return s?t.filter(o=>(o.nome??"").toLowerCase().includes(s)):t},[t,V]),C=d??t.find(s=>s.id===Number(x)),U=n.useMemo(()=>xe(C==null?void 0:C.disponibilidade).sort((o,u)=>o.diaSemana!==u.diaSemana?o.diaSemana-u.diaSemana:_(o.horario).localeCompare(_(u.horario))),[C]);n.useEffect(()=>{G("")},[g]),n.useEffect(()=>{if(!T)return;!t.some(o=>o.id===Number(x))&&t.length&&!E&&D(t[0].id)},[T,t,x,E]),n.useEffect(()=>{!E&&x&&b([])},[x,E]),n.useEffect(()=>{if(a){const s=[];if(a.horarios&&a.horarios.length>0)for(const o of a.horarios){const u=o.horarioInicio?String(o.horarioInicio).slice(0,5):"08:00",A=o.horarioFim?String(o.horarioFim).slice(0,5):void 0;s.push({diaSemana:o.diaSemana,horarioInicio:u,...A&&{horarioFim:A}})}else if(a.diaSemana!=null&&a.horarioInicio!=null){const o=String(a.horarioInicio).slice(0,5);s.push({diaSemana:a.diaSemana,horarioInicio:o})}b(s),N(a.capacidade??""),v(a.instrumentoId||""),D(a.professorId||""),F(a.ativo!==!1),a.instrumentoGrupoId?S(String(a.instrumentoGrupoId)):a.instrumentoId&&w().get("/instrumentos/ativos").then(o=>{const u=o.data.find(A=>A.id===a.instrumentoId);u!=null&&u.grupoId&&S(String(u.grupoId))})}else S(""),v(""),D(""),b([]),F(!0)},[a]);function W(s){ce(s);const o=_(s.horario);return c.some(u=>u.diaSemana===s.diaSemana&&u.horarioInicio===o)}function X(s){const o=_(s.horario),u=je(s.horario),A={diaSemana:s.diaSemana,horarioInicio:o,...u&&{horarioFim:u}};b(Y=>Y.some(z=>z.diaSemana===s.diaSemana&&z.horarioInicio===o)?Y.filter(z=>!(z.diaSemana===s.diaSemana&&z.horarioInicio===o)):[...Y,A])}function se(s){s.preventDefault(),j(""),q(!1);const o=!p,u=!g,A=!x,Y=c.length===0,Z=Number(h),z=!Z||Z<1;if(o||u||A||Y||z){j("Preencha os campos obrigatórios."),q(!0);return}Q(!0);const te=y=>y.length===5?y:y+":00",ne={horarios:c.map(y=>({diaSemana:y.diaSemana,horarioInicio:te(y.horarioInicio),...y.horarioFim&&{horarioFim:te(y.horarioFim)}})),capacidade:Number(h)>=1?Number(h):void 0,instrumentoId:Number(g),professorId:Number(x),ativo:!!L},oe=w();(E?oe.put(`/turmas/${a.id}`,ne):oe.post("/turmas",ne)).then(()=>i()).catch(y=>{var re,ie;return j(((ie=(re=y==null?void 0:y.response)==null?void 0:re.data)==null?void 0:ie.mensagem)||"Erro ao salvar.")}).finally(()=>Q(!1))}return e.jsx("div",{className:"modal-overlay",onClick:l,children:e.jsxs("div",{className:"modal",onClick:s=>s.stopPropagation(),children:[e.jsx("div",{className:"modal-header",children:e.jsx("h2",{children:r(E?"turmas.editClass":"turmas.newClassTitle")})}),e.jsxs("form",{onSubmit:se,className:"modal-body",children:[m&&e.jsx("div",{className:"alert alert-error",children:m}),e.jsx("div",{className:"form-row",children:e.jsxs("div",{className:`form-group ${$&&!p?"field-error":""}`,children:[e.jsx("label",{children:"Grupo do instrumento *"}),e.jsx(le,{value:p,onChange:s=>K(s),searchUrl:"/grupos",placeholder:"Selecione o grupo",emptyOption:{value:"",label:"Selecione o grupo"},required:!0})]})}),e.jsx("div",{className:"form-row",children:e.jsxs("div",{className:`form-group ${$&&!g?"field-error":""}`,children:[e.jsx("label",{children:"Instrumento *"}),e.jsx(le,{value:String(g||""),onChange:s=>J(s),searchUrl:"/instrumentos",placeholder:p?"Selecione o instrumento":"Selecione o grupo antes",disabled:!p,extraParams:p?{grupoId:p}:{},required:!0})]})}),e.jsx("div",{className:"form-row",children:e.jsxs("div",{className:`form-group form-group-select-search ${$&&!x?"field-error":""}`,children:[e.jsx("label",{children:"Professor *"}),g?t.length===0?e.jsx("input",{type:"text",readOnly:!0,disabled:!0,placeholder:"Nenhum professor leciona este instrumento",className:"select-search-input"}):e.jsxs("div",{className:"select-search-wrap",children:[e.jsx("input",{type:"text",className:"select-search-input",placeholder:"Digite para buscar o professor...",value:R?V:(C==null?void 0:C.nome)??"",onChange:s=>{G(s.target.value),B(!0)},onFocus:()=>B(!0),onBlur:()=>setTimeout(()=>B(!1),200),autoComplete:"off","aria-label":"Buscar professor"}),R&&e.jsx("ul",{className:"select-search-dropdown",role:"listbox",children:P.length===0?e.jsx("li",{className:"select-search-dropdown-empty",children:"Nenhum professor encontrado"}):P.map(s=>e.jsx("li",{role:"option",className:"select-search-dropdown-item",onMouseDown:o=>{o.preventDefault(),D(String(s.id)),G(""),B(!1)},children:s.nome},s.id))})]}):e.jsx("input",{type:"text",readOnly:!0,disabled:!0,placeholder:"Selecione o instrumento antes",className:"select-search-input"}),g&&t.length>0&&e.jsx("p",{className:"form-hint",children:"Professores que lecionam o instrumento selecionado. Digite para filtrar."})]})}),e.jsxs("div",{className:`form-group ${$&&c.length===0?"field-error":""}`,children:[e.jsx("label",{children:"Dias e horários *"}),x?U.length===0?e.jsx("p",{className:"form-hint",style:{color:"var(--text-muted)"},children:r("turmas.noScheduleProfessor")}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"form-hint",children:"Selecione os dias e horários em que esta turma ocorrerá (uma única turma)."}),e.jsx("div",{className:"turma-slots-grid",children:U.map(s=>e.jsxs("label",{className:"turma-slot-chip",children:[e.jsx("input",{type:"checkbox",checked:W(s),onChange:()=>X(s)}),e.jsx("span",{children:Se(s)})]},ce(s)))}),c.length>0&&e.jsxs("p",{className:"form-hint turma-slots-resumo",children:["1 turma com ",c.length," dia(s)/horário(s)"]})]}):e.jsx("p",{className:"form-hint",children:"Selecione o professor para ver a disponibilidade."})]}),e.jsxs("div",{className:`form-group ${$&&(!(Number(h)>=1)||h==="")?"field-error":""}`,children:[e.jsx("label",{children:"Capacidade *"}),e.jsx("input",{type:"number",min:1,value:h,onChange:s=>N(s.target.value),required:!0}),E&&(a==null?void 0:a.capacidadePreenchida)!=null&&(a==null?void 0:a.capacidade)!=null&&e.jsxs("p",{className:"form-hint",children:["Vagas preenchidas: ",a.capacidadePreenchida,"/",a.capacidade]})]}),e.jsxs("div",{className:"form-group form-group-status",children:[e.jsxs("div",{className:"status-ativo",children:[e.jsx("input",{type:"checkbox",id:"turma-ativo",checked:L,onChange:s=>F(s.target.checked),className:"status-checkbox"}),e.jsx("label",{htmlFor:"turma-ativo",className:"status-label",children:"Turma ativa (aparece para novas matrículas e nas listas)"})]}),e.jsx("p",{className:"form-hint",children:"Desmarque para marcar a turma como inativa."})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-outline",onClick:l,children:r("common.cancel")}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:se,disabled:H,children:r(H?"common.saving":"common.save")})]})]})})}function Ne(a){var i,r;return a?(typeof a=="string"?a:((r=(i=a.toISOString)==null?void 0:i.call(a))==null?void 0:r.slice(0,10))??"").slice(0,10):""}function ee(){const a=new Date;return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-${String(a.getDate()).padStart(2,"0")}`}function ve(a){var l;return(l=a.horarios)!=null&&l.length?a.horarios.map(i=>i.diaSemana).filter(i=>i!=null):a.diaSemana!=null?[a.diaSemana]:[]}function Ce(a,l){const i=ve(a);if(i.length===0)return!1;const r=new Date(l+"T12:00:00"),c=r.getDay()===0?7:r.getDay();return i.includes(c)}function Ie({turma:a,onFechar:l,onSalvo:i}){const{t:r}=ae(),[c,b]=n.useState(()=>ee()),[h,N]=n.useState([]),[p,S]=n.useState(!1),[g,v]=n.useState(!0),[x,D]=n.useState("");n.useEffect(()=>{!(a!=null&&a.id)||!c||(v(!0),D(""),w().get(`/turmas/${a.id}/presencas`,{params:{data:c}}).then(d=>N(d.data||[])).catch(()=>{N([]),D("Erro ao carregar lista de chamada.")}).finally(()=>v(!1)))},[a==null?void 0:a.id,c]);function L(d){N(f=>f.map(m=>m.matriculaId===d?{...m,presente:!m.presente}:m))}function F(d,f){N(m=>m.map(j=>j.matriculaId===d?{...j,conteudoAula:f}:j))}function k(d){if(d.preventDefault(),!(a!=null&&a.id))return;D(""),S(!0);const f={dataAula:c,registros:h.map(m=>{var j;return{matriculaId:m.matriculaId,presente:m.pagamentoEmDia!==!1&&m.presente!==!1,conteudoAula:((j=m.conteudoAula)==null?void 0:j.trim())||void 0}})};w().post(`/turmas/${a.id}/presencas`,f).then(()=>i==null?void 0:i()).catch(m=>D(he(m).mensagem)).finally(()=>S(!1))}if(!a)return null;const M=ee(),I=c>M,O=!I&&Ce(a,c);return e.jsx("div",{className:"modal-overlay",onClick:l,children:e.jsxs("div",{className:"modal modal-chamada",onClick:d=>d.stopPropagation(),children:[e.jsx("div",{className:"modal-header",children:e.jsxs("h2",{children:["Chamada — ",a.instrumentoNome]})}),e.jsxs("form",{onSubmit:k,className:"modal-body",children:[x&&e.jsx("div",{className:"alert alert-error",children:x}),e.jsx("div",{className:"form-row",children:e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Data da aula *"}),e.jsx("input",{type:"date",value:Ne(c),onChange:d=>b(d.target.value),placeholder:"DD/MM/AAAA",max:ee(),required:!0})]})}),I?e.jsx("p",{className:"empty-state",children:"Não é possível fazer chamada em data futura. Selecione uma data até hoje."}):O?g?e.jsx("p",{children:"Carregando alunos..."}):h.length===0?e.jsx("p",{className:"empty-state",children:"Nenhum aluno matriculado nesta turma."}):e.jsxs("div",{className:"chamada-lista",children:[e.jsx("p",{className:"form-hint",children:"Marque presença ou falta para cada aluno. Alunos com pagamento em atraso não podem ter presença marcada — regularize no financeiro."}),e.jsx("ul",{children:h.map(d=>{const f=d.pagamentoEmDia!==!1,m=f?d.presente!==!1:!1;return e.jsxs("li",{className:"chamada-item",children:[e.jsx("div",{className:"chamada-item-header",children:e.jsxs("label",{children:[e.jsx("input",{type:"checkbox",checked:m,onChange:()=>f&&L(d.matriculaId),disabled:!f}),e.jsx("span",{className:m?"":"falta",children:d.alunoNome}),!f&&e.jsx("span",{className:"badge badge-danger",style:{marginLeft:"0.5rem"},title:"Pagamento em atraso",children:"Atrasado"})]})}),e.jsxs("div",{className:"form-group chamada-conteudo",children:[e.jsx("label",{htmlFor:`conteudo-${d.matriculaId}`,children:"Conteúdo da aula"}),e.jsx("textarea",{id:`conteudo-${d.matriculaId}`,value:d.conteudoAula??"",onChange:j=>F(d.matriculaId,j.target.value),placeholder:"Descreva o conteúdo ministrado nesta aula para o aluno...",rows:2})]})]},d.matriculaId)})})]}):e.jsx("p",{className:"empty-state",children:"Nenhuma aula desta turma nesta data (verifique o dia da semana)."})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-outline",onClick:l,children:r("common.cancel")}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:k,disabled:p||g||I||!O||h.length===0,children:r(p?"common.saving":"common.saveAttendance")})]})]})})}const ye=["","Segunda","Terça","Quarta","Quinta","Sexta"];function de(a){if(!a)return"";const l=String(a);return l.length<=2?l+"h":l.slice(0,5).replace(":","h")}function De(a){const l=a.horarios&&a.horarios.length>0?a.horarios:a.diaSemana!=null&&a.horarioInicio!=null?[{diaSemana:a.diaSemana,horarioInicio:a.horarioInicio}]:[];return l.length===0?"—":l.map(i=>{const r=de(i.horarioInicio),c=de(i.horarioFim),b=c?`${r} às ${c}`:r;return`${ye[i.diaSemana]??i.diaSemana} ${b}`.trim()}).join(", ")}function Me(){const{t:a}=ae(),{user:l}=ue(),i=(l==null?void 0:l.perfil)==="PROFESSOR",[r,c]=n.useState(null),[b,h]=n.useState(0),[N,p]=n.useState(10),[S,g]=n.useState(""),[v,x]=n.useState(""),[D,L]=n.useState(!0);n.useEffect(()=>{if(i)return;const t=setTimeout(()=>{g(v),h(0)},300);return()=>clearTimeout(t)},[i,v]);const[F,k]=n.useState(""),[M,I]=n.useState(!1),[O,d]=n.useState(null),[f,m]=n.useState(null),[j,H]=n.useState(null),[Q,$]=n.useState(null),q=n.useCallback(()=>{L(!0);const t=new URLSearchParams({page:String(b),size:String(N)});!i&&S.trim()&&t.set("busca",S.trim()),w().get(`/turmas?${t}`).then(P=>c(P.data)).catch(()=>k(a("common.errorLoading"))).finally(()=>L(!1))},[b,N,S,i]);n.useEffect(()=>q(),[q]);function V(){d(null),I(!0)}function G(t){d(t),I(!0)}function R(){I(!1),d(null),q()}function B(t){m(t)}function E(){m(null)}function K(t){$(t)}function J(){Q!=null&&w().delete(`/turmas/${Q}`).then(()=>{$(null),q()}).catch(t=>{var P,C;$(null),k(((C=(P=t==null?void 0:t.response)==null?void 0:P.data)==null?void 0:C.mensagem)||a("common.errorDeleting"))})}const T=(r==null?void 0:r.content)??[];return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"page-header",children:[e.jsx("h1",{children:a("turmas.title")}),!i&&e.jsx("button",{type:"button",className:"btn btn-primary",onClick:V,children:a("turmas.newClass")})]}),F&&e.jsx("div",{className:"alert alert-error",children:F}),!i&&e.jsx("div",{className:"busca-wrap",children:e.jsx("input",{type:"search",placeholder:a("turmas.searchPlaceholder"),value:v,onChange:t=>x(t.target.value),"aria-label":a("turmas.searchPlaceholder")})}),D?e.jsx("p",{children:a("common.loading")}):e.jsx("div",{className:"card",children:T.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("p",{children:a("turmas.noClassFound")}),!i&&e.jsx("button",{type:"button",className:"btn btn-primary",onClick:V,children:a("turmas.registerClass")})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"table-wrap",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:"32px"}}),e.jsx("th",{children:a("turmas.instrument")}),!i&&e.jsx("th",{children:a("turmas.teacher")}),e.jsx("th",{children:a("turmas.capacity")}),e.jsx("th",{children:a("turmas.daysAndTimes")}),e.jsx("th",{children:a("matriculas.active")}),e.jsx("th",{className:"actions-cell",children:a("common.actions")})]})}),e.jsx("tbody",{children:T.map(t=>{var P,C,U;return e.jsxs(n.Fragment,{children:[e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("button",{type:"button",className:"turma-expand-btn",onClick:()=>H(j===t.id?null:t.id),title:(((P=t.alunos)==null?void 0:P.length)??0)>0?a("turmas.seeStudents"):a("turmas.noStudents"),"aria-expanded":j===t.id,children:(((C=t.alunos)==null?void 0:C.length)??0)>0?j===t.id?"−":"+":"·"})}),e.jsx("td",{children:t.instrumentoNome}),!i&&e.jsx("td",{children:t.professorNome}),e.jsx("td",{children:t.capacidade!=null&&t.capacidadePreenchida!=null?`${t.capacidadePreenchida}/${t.capacidade}`:t.capacidade??"—"}),e.jsx("td",{children:De(t)}),e.jsx("td",{children:t.ativo!==!1?e.jsx("span",{className:"badge badge-success",children:a("common.yes")}):e.jsx("span",{className:"badge badge-danger",children:a("common.no")})}),e.jsxs("td",{className:"actions-cell",children:[e.jsx("button",{type:"button",className:"btn btn-outline",onClick:()=>B(t),children:a("professores.attendance")}),!i&&e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"btn btn-outline",onClick:()=>G(t),children:a("common.edit")}),e.jsx("button",{type:"button",className:"btn btn-danger",onClick:()=>K(t.id),children:a("common.delete")})]})]})]}),j===t.id&&(((U=t.alunos)==null?void 0:U.length)??0)>0&&e.jsx("tr",{className:"turma-alunos-row",children:e.jsx("td",{colSpan:i?6:7,children:e.jsxs("div",{className:"turma-alunos-wrap",children:[e.jsx("strong",{children:a("turmas.studentsLabel")}),e.jsx("ul",{className:"turma-alunos-list",children:t.alunos.map((W,X)=>e.jsx("li",{children:W},X))})]})})},`${t.id}-alunos`)]},t.id)})})]})}),r&&r.totalPages>0&&e.jsx(me,{page:r.number,totalPages:r.totalPages,totalElements:r.totalElements,size:r.size,onPageChange:h,onSizeChange:t=>{p(t),h(0)}})]})}),M&&e.jsx(be,{turma:O,onFechar:R,onSalvo:R}),f&&e.jsx(Ie,{turma:f,onFechar:E,onSalvo:E}),Q!=null&&e.jsx(pe,{titulo:a("turmas.deleteClass"),mensagem:a("turmas.deleteClassConfirm"),confirmarTexto:a("common.delete"),cancelarTexto:a("common.cancel"),perigo:!0,onConfirmar:J,onCancelar:()=>$(null)})]})}export{Me as default};
