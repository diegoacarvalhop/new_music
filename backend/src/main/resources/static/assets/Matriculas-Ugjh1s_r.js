import{r as o,j as e}from"./react-vendor-CQulTfZ0.js";import{u as fe,g as Q,c as De,f as U,P as Ce}from"./index-Cs2E90Ho.js";import{c as pe,d as ke,s as ge,a as Ee}from"./validacao-D9FFwnBf.js";import{M as Ae}from"./ModalConfirm-BN9a4XRF.js";import"./router-MSaW0Gl8.js";import"./axios-D5GkNzM3.js";function $e({matricula:s,onFechar:i,onSalvo:W}){var ue;const{t:g}=fe(),[l,w]=o.useState(""),[R,j]=o.useState(""),[H,D]=o.useState(""),[M,C]=o.useState(1),[z,I]=o.useState(!0),[k,L]=o.useState(""),[u,J]=o.useState(""),[E,v]=o.useState(""),[A,N]=o.useState(!1),[P,F]=o.useState(""),[O,T]=o.useState(!1),[S,_]=o.useState([]),[r,f]=o.useState([]),[V,K]=o.useState(""),[se,te]=o.useState(!1),[X,ne]=o.useState(!1),B=!!(s!=null&&s.id),q=S.filter(a=>a.ativo!==!1),Y=B&&(s!=null&&s.alunoId)&&!q.some(a=>a.id===s.alunoId)?[...S.filter(a=>a.id===s.alunoId),...q]:q,oe=o.useMemo(()=>{const a=E.trim().toLowerCase();return a?Y.filter(t=>(t.nome??"").toLowerCase().includes(a)):Y},[Y,E]),re=o.useMemo(()=>{const a=P.trim().toLowerCase();return a?r.filter(t=>`${t.instrumentoNome??""} ${t.professorNome??""}`.toLowerCase().includes(a)):r},[r,P]);function le(a){const t=a.capacidade!=null&&a.capacidadePreenchida!=null?` ${a.capacidadePreenchida}/${a.capacidade}`:"",n=(s==null?void 0:s.turmaId)??null,c=a.capacidade!=null&&(a.capacidadePreenchida??0)>=a.capacidade&&n!=null&&n!==a.id;return`${a.instrumentoNome} — ${a.professorNome}${t}${c?" (lotada)":""}`}o.useEffect(()=>{Q().get("/alunos").then(a=>{var n;const t=Array.isArray((n=a.data)==null?void 0:n.content)?a.data.content:[];_(t)}),Q().get("/turmas").then(a=>{var t;return f(Array.isArray((t=a.data)==null?void 0:t.content)?a.data.content:[])})},[]);const $=r.find(a=>a.id===Number(u)),ie=(($==null?void 0:$.instrumentoGrupoNome)??"").toLowerCase()==="canto",ce=De(l,M,ie),x=o.useMemo(()=>{const a=($==null?void 0:$.horarios)??[];if(a.length===0)return null;const t=new Set(a.map(n=>n.diaSemana).filter(n=>n!=null));return t.size>0?t:null},[$]),je=["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"],Ne=["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"],[m,Z]=o.useState({ano:new Date().getFullYear(),mes:new Date().getMonth()}),[ee,ae]=o.useState(!1);o.useEffect(()=>{if(l&&/^\d{4}-\d{2}-\d{2}$/.test(l.slice(0,10))){const[a,t]=l.slice(0,10).split("-").map(Number);Z(n=>n.ano===a&&n.mes===t-1?n:{ano:a,mes:t-1})}},[l]);const be=o.useMemo(()=>x&&x.size>0?x:new Set([1,2,3,4,5]),[x]),ve=o.useMemo(()=>{const{ano:a,mes:t}=m,n=new Date(a,t,1),c=new Date(a,t+1,0),b=n.getDay(),d=c.getDate(),y=[];let h=[];for(let p=0;p<b;p++)h.push(null);for(let p=1;p<=d;p++)h.push(p),h.length===7&&(y.push(h),h=[]);if(h.length){for(;h.length<7;)h.push(null);y.push(h)}return y},[m]);function G(a){const{ano:t,mes:n}=m,c=new Date(t,n,a);return be.has(c.getDay())}function Se(a){if(!G(a))return;const{ano:t,mes:n}=m,c=t,b=String(n+1).padStart(2,"0"),d=String(a).padStart(2,"0");w(`${c}-${b}-${d}`),ae(!1)}function ye(a){const{ano:t,mes:n}=m,c=String(n+1).padStart(2,"0"),b=String(a).padStart(2,"0");return`${t}-${c}-${b}`}const we=o.useMemo(()=>{if(!l||!/^\d{4}-\d{2}-\d{2}$/.test(l.slice(0,10)))return!1;const[a,t]=l.slice(0,10).split("-").map(Number);return a===m.ano&&t===m.mes+1},[l,m]);o.useEffect(()=>{if(x&&x.size>0&&l&&/^\d{4}-\d{2}-\d{2}$/.test(l.slice(0,10))){const[a,t,n]=l.slice(0,10).split("-").map(Number),c=new Date(a,t-1,n);if(!x.has(c.getDay())){const b=new Date;b.setHours(0,0,0,0);let d=new Date(b);for(;!x.has(d.getDay());)d.setDate(d.getDate()+1);const y=d.getFullYear(),h=String(d.getMonth()+1).padStart(2,"0"),p=String(d.getDate()).padStart(2,"0");w(`${y}-${h}-${p}`)}}},[x,l]),o.useEffect(()=>{if(s)w(s.dataInicio?s.dataInicio.slice(0,10):""),j(s.valorCurso!=null?pe(String(Math.round(Number(s.valorCurso)*100))):""),D(s.dataVencimento?s.dataVencimento.slice(0,10):""),C(s.aulasPorSemana===2?2:1),I(s.ativo!==!1),L(s.alunoId||""),J(s.turmaId||""),v(""),F("");else{const a=new Date().toISOString().slice(0,10);w(a),j(""),D(""),C(1),I(!0);const t=S.filter(n=>n.ativo!==!1);t.length&&L(t[0].id),v(""),F("")}},[s,S.length,r.length]),o.useEffect(()=>{var a;if(!B&&u&&r.length>0){const t=r.find(n=>n.id===Number(u));if(t){const n=(t.aulasPorSemana??((a=t.horarios)==null?void 0:a.length)??1)===2?2:1;C(n)}}},[B,u,r]);function de(a){a.preventDefault(),K(""),ne(!1);const t=!k,n=!u,c=!l.trim();if(t||n||c){K("Preencha os campos obrigatórios."),ne(!0);return}te(!0);const d=Q(),y={dataInicio:l,ativo:z,valorCurso:ke(R),dataVencimento:H||void 0,aulasPorSemana:M,alunoId:Number(k),turmaId:Number(u)};(B?d.put(`/matriculas/${s.id}`,y):d.post("/matriculas",y)).then(()=>W()).catch(p=>{var me,he;return K(((he=(me=p==null?void 0:p.response)==null?void 0:me.data)==null?void 0:he.mensagem)||"Erro ao salvar.")}).finally(()=>te(!1))}return e.jsx("div",{className:"modal-overlay",onClick:i,children:e.jsxs("div",{className:"modal",onClick:a=>a.stopPropagation(),children:[e.jsx("div",{className:"modal-header",children:e.jsx("h2",{children:g(B?"matriculas.editEnrollment":"matriculas.newEnrollment")})}),e.jsxs("form",{onSubmit:de,className:"modal-body modal-matricula-form",children:[V&&e.jsx("div",{className:"alert alert-error",children:V}),e.jsx("div",{className:"form-row form-row-matricula",children:e.jsxs("div",{className:`form-group form-group-full ${X&&!k?"field-error":""}`,children:[e.jsx("label",{children:"Aluno *"}),q.length===0&&S.length>0?e.jsx("input",{type:"text",className:"select-search-input",readOnly:!0,disabled:!0,placeholder:"Nenhum aluno ativo"}):e.jsxs("div",{className:"select-search-wrap",children:[e.jsx("input",{type:"text",className:"select-search-input",placeholder:"Digite para buscar o aluno...",value:A?E:((ue=Y.find(a=>a.id===Number(k)))==null?void 0:ue.nome)??"",onChange:a=>{v(a.target.value),N(!0)},onFocus:()=>N(!0),onBlur:()=>setTimeout(()=>N(!1),200),autoComplete:"off","aria-label":"Buscar aluno"}),A&&e.jsx("ul",{className:"select-search-dropdown",role:"listbox",children:oe.length===0?e.jsx("li",{className:"select-search-dropdown-empty",children:"Nenhum aluno encontrado"}):oe.map(a=>e.jsxs("li",{role:"option",className:"select-search-dropdown-item",onMouseDown:t=>{t.preventDefault(),L(String(a.id)),v(""),N(!1)},children:[a.nome,a.ativo===!1?" (inativo)":""]},a.id))})]}),S.length>0&&q.length===0&&e.jsx("p",{className:"form-hint",children:"Nenhum aluno ativo. Ative o cadastro do aluno para matricular."})]})}),e.jsx("div",{className:"form-row form-row-matricula",children:e.jsxs("div",{className:`form-group form-group-full ${X&&!u?"field-error":""}`,children:[e.jsx("label",{children:"Turma *"}),r.length===0?e.jsx("input",{type:"text",className:"select-search-input",readOnly:!0,disabled:!0,placeholder:"Nenhuma turma cadastrada"}):e.jsxs("div",{className:"select-search-wrap",children:[e.jsx("input",{type:"text",className:"select-search-input",placeholder:"Digite para buscar a turma (instrumento ou professor)...",value:O?P:(()=>{const a=r.find(t=>t.id===Number(u));return a?le(a):""})(),onChange:a=>{F(a.target.value),T(!0)},onFocus:()=>T(!0),onBlur:()=>setTimeout(()=>T(!1),200),autoComplete:"off","aria-label":"Buscar turma"}),O&&e.jsx("ul",{className:"select-search-dropdown",role:"listbox",children:re.length===0?e.jsx("li",{className:"select-search-dropdown-empty",children:"Nenhuma turma encontrada"}):re.map(a=>{const t=a.capacidade!=null&&(a.capacidadePreenchida??0)>=a.capacidade&&(s==null?void 0:s.turmaId)!==a.id;return e.jsx("li",{role:"option",className:"select-search-dropdown-item",onMouseDown:n=>{n.preventDefault(),t||(J(String(a.id)),F(""),T(!1))},style:t?{opacity:.6,cursor:"not-allowed"}:void 0,children:le(a)},a.id)})})]}),e.jsx("p",{className:"form-hint",children:"Selecione a turma primeiro; as aulas por semana serão definidas pela turma."})]})}),e.jsx("div",{className:"form-row form-row-matricula",children:e.jsxs("div",{className:"form-group form-group-radios",children:[e.jsx("label",{children:"Aulas por semana *"}),e.jsxs("div",{className:"radio-group-inline",children:[e.jsxs("label",{className:"radio-option",children:[e.jsx("input",{type:"radio",name:"aulasPorSemana",checked:M===1,onChange:()=>C(1)}),e.jsx("span",{children:"1 aula por semana"})]}),e.jsxs("label",{className:"radio-option",children:[e.jsx("input",{type:"radio",name:"aulasPorSemana",checked:M===2,onChange:()=>C(2)}),e.jsx("span",{children:"2 aulas por semana"})]})]})]})}),e.jsxs("div",{className:"form-row form-row-matricula",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Valor do curso (R$)"}),e.jsx("input",{type:"text",inputMode:"numeric",value:R,onChange:a=>j(pe(a.target.value)),placeholder:"Ex: 150,00"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Dia de vencimento"}),e.jsx("input",{type:"date",value:H,onChange:a=>D(a.target.value),placeholder:"DD/MM/AAAA",title:"Dia de vencimento mensal (o dia será usado para todos os meses)"})]})]}),e.jsxs("div",{className:"form-row form-row-matricula",children:[e.jsxs("div",{className:`form-group ${X&&!l.trim()?"field-error":""}`,children:[e.jsx("label",{children:"Data início *"}),e.jsxs("div",{className:"date-picker-wrap date-picker-single-field",children:[e.jsx("input",{type:"hidden",value:l,readOnly:!0,"aria-hidden":!0}),e.jsxs("button",{type:"button",className:`date-picker-trigger ${l?"":"date-picker-trigger-placeholder"}`,onClick:()=>ae(a=>!a),"aria-expanded":ee,"aria-haspopup":"dialog","aria-label":"Escolher data de início",children:[l?U(l):"Selecione a data",e.jsx("span",{className:"date-picker-trigger-icon","aria-hidden":!0,children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("rect",{x:"3",y:"4",width:"18",height:"18",rx:"2",ry:"2"}),e.jsx("line",{x1:"16",y1:"2",x2:"16",y2:"6"}),e.jsx("line",{x1:"8",y1:"2",x2:"8",y2:"6"}),e.jsx("line",{x1:"3",y1:"10",x2:"21",y2:"10"})]})})]}),ee&&e.jsx("div",{className:"date-picker-dropdown",onMouseDown:a=>a.preventDefault(),children:e.jsxs("div",{className:"date-picker-calendario",children:[e.jsxs("div",{className:"date-picker-calendario-header",children:[e.jsx("button",{type:"button",className:"date-picker-nav",onClick:()=>Z(a=>a.mes===0?{ano:a.ano-1,mes:11}:{ano:a.ano,mes:a.mes-1}),"aria-label":"Mês anterior",children:"‹"}),e.jsxs("span",{className:"date-picker-mes-ano",children:[je[m.mes]," ",m.ano]}),e.jsx("button",{type:"button",className:"date-picker-nav",onClick:()=>Z(a=>a.mes===11?{ano:a.ano+1,mes:0}:{ano:a.ano,mes:a.mes+1}),"aria-label":"Próximo mês",children:"›"})]}),e.jsx("div",{className:"date-picker-weekdays",children:Ne.map(a=>e.jsx("span",{className:"date-picker-weekday",children:a},a))}),e.jsx("div",{className:"date-picker-grid",children:ve.map((a,t)=>a.map((n,c)=>e.jsx("div",{className:"date-picker-cell-wrap",children:n===null?e.jsx("span",{className:"date-picker-cell date-picker-cell-empty"}):e.jsx("button",{type:"button",className:`date-picker-cell date-picker-cell-day ${G(n)?"date-picker-cell-ativo":"date-picker-cell-inativo"} ${we&&l===ye(n)?"date-picker-cell-selecionado":""}`,onClick:()=>Se(n),disabled:!G(n),title:G(n)?`Selecionar ${n}/${m.mes+1}/${m.ano}`:"Dia não disponível para esta turma",children:n})},`${t}-${c}`)))})]})})]}),ee&&e.jsx("div",{className:"date-picker-backdrop",role:"presentation",onMouseDown:()=>ae(!1),"aria-hidden":!0}),x!=null&&x.size>0&&e.jsx("p",{className:"form-hint",children:"Clique no campo para abrir o calendário. Dias em que a turma tem aula estão ativos."})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Data fim do curso"}),e.jsx("div",{className:"form-readonly",title:ie?"Canto: 2 aulas/semana = 3 meses, 1 aula/semana = 6 meses":"Calculada: 2 aulas/semana = 1 ano, 1 aula/semana = 2 anos",children:ce?U(ce):"—"})]})]}),e.jsxs("div",{className:"form-group form-group-status",children:[e.jsxs("div",{className:"status-ativo",children:[e.jsx("input",{type:"checkbox",id:"matricula-ativo",checked:z,onChange:a=>I(a.target.checked),className:"status-checkbox"}),e.jsx("label",{htmlFor:"matricula-ativo",className:"status-label",children:g("matriculas.enrollmentActiveHint")})]}),e.jsx("p",{className:"form-hint",children:"Desmarque para marcar a matrícula como inativa."})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-outline",onClick:i,children:g("common.cancel")}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:de,disabled:se,children:g(se?"common.saving":"common.save")})]})]})})}function xe(s){const i=s.trim();return i.length?/^[\d.\s-]*$/.test(i)&&ge(i).length>0:!1}function Le(){const{t:s}=fe(),[i,W]=o.useState(null),[g,l]=o.useState(0),[w,R]=o.useState(10),[j,H]=o.useState(""),[D,M]=o.useState(""),[C,z]=o.useState(!0);o.useEffect(()=>{const r=setTimeout(()=>{H(D),l(0)},300);return()=>clearTimeout(r)},[D]);const[I,k]=o.useState(""),[L,u]=o.useState(!1),[J,E]=o.useState(null),[v,A]=o.useState(null),N=o.useCallback(()=>{z(!0);const r=new URLSearchParams({page:String(g),size:String(w)});j.trim()&&r.set("busca",xe(j)?ge(j):j.trim()),Q().get(`/matriculas?${r}`).then(f=>W(f.data)).catch(()=>k(s("common.errorLoading"))).finally(()=>z(!1))},[g,w,j]);o.useEffect(()=>N(),[N]);function P(){E(null),u(!0)}function F(r){E(r),u(!0)}function O(){u(!1),E(null),N()}function T(r){A(r)}function S(){v!=null&&Q().delete(`/matriculas/${v}`).then(()=>{A(null),N()}).catch(r=>{var f,V;A(null),k(((V=(f=r==null?void 0:r.response)==null?void 0:f.data)==null?void 0:V.mensagem)||s("common.errorDeleting"))})}new Date().toISOString().slice(0,10);const _=(i==null?void 0:i.content)??[];return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"page-header",children:[e.jsx("h1",{children:s("matriculas.title")}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:P,children:s("matriculas.newEnrollment")})]}),I&&e.jsx("div",{className:"alert alert-error",children:I}),e.jsx("div",{className:"busca-wrap",children:e.jsx("input",{type:"search",placeholder:s("common.searchByNameOrCpf"),value:D,onChange:r=>{const f=r.target.value;M(xe(f)?Ee(f):f)},"aria-label":s("common.searchByNameOrCpf")})}),C?e.jsx("p",{children:s("common.loading")}):e.jsx("div",{className:"card",children:_.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("p",{children:s("matriculas.noEnrollmentFound")}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:P,children:s("matriculas.registerEnrollment")})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"table-wrap",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:s("matriculas.student")}),e.jsx("th",{children:s("matriculas.startDate")}),e.jsx("th",{children:s("matriculas.endDate")}),e.jsx("th",{children:s("matriculas.active")}),e.jsx("th",{className:"actions-cell",children:s("common.actions")})]})}),e.jsx("tbody",{children:_.map(r=>e.jsxs("tr",{children:[e.jsx("td",{children:r.alunoNome}),e.jsx("td",{children:U(r.dataInicio)}),e.jsx("td",{children:U(r.dataFim)||"—"}),e.jsx("td",{children:r.ativo?e.jsx("span",{className:"badge badge-success",children:s("common.yes")}):e.jsx("span",{className:"badge badge-danger",children:s("common.no")})}),e.jsxs("td",{className:"actions-cell",children:[e.jsx("button",{type:"button",className:"btn btn-outline",onClick:()=>F(r),children:s("common.edit")}),e.jsx("button",{type:"button",className:"btn btn-danger",onClick:()=>T(r.id),children:s("common.delete")})]})]},r.id))})]})}),i&&i.totalPages>0&&e.jsx(Ce,{page:i.number,totalPages:i.totalPages,totalElements:i.totalElements,size:i.size,onPageChange:l,onSizeChange:r=>{R(r),l(0)}})]})}),L&&e.jsx($e,{matricula:J,onFechar:O,onSalvo:O}),v!=null&&e.jsx(Ae,{titulo:s("matriculas.deleteEnrollment"),mensagem:s("matriculas.deleteEnrollmentConfirm"),confirmarTexto:s("common.delete"),cancelarTexto:s("common.cancel"),perigo:!0,onConfirmar:S,onCancelar:()=>A(null)})]})}export{Le as default};
