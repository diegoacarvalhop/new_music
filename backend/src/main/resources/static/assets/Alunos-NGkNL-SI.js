import{r as n,j as e}from"./react-vendor-CQulTfZ0.js";import{u as Q,g as Y,S as le,f as ae,P as se}from"./index-Cs2E90Ho.js";import{a as S,g as ce}from"./apiErrors-CU3vO3iu.js";import{m as K,a as H,s as L,v as J,b as _}from"./validacao-D9FFwnBf.js";import{M as ie}from"./ModalConfirm-BN9a4XRF.js";import"./router-MSaW0Gl8.js";import"./axios-D5GkNzM3.js";function de({aluno:t,onFechar:l,onSalvo:D}){const{t:h}=Q(),[p,w]=n.useState(""),[v,b]=n.useState(""),[B,A]=n.useState(""),[g,E]=n.useState(""),[N,O]=n.useState(""),[j,$]=n.useState(""),[u,q]=n.useState(""),[F,P]=n.useState(""),[T,d]=n.useState(""),[M,x]=n.useState(!0),[I,C]=n.useState(""),[m,R]=n.useState({}),[V,z]=n.useState(!1),[y,k]=n.useState(!1),U=!!(t!=null&&t.id);n.useEffect(()=>{t?(w(t.nome||""),b(t.email||""),A(t.telefone?K(t.telefone):""),E(t.cpf?H(t.cpf):""),O(t.dataNascimento?t.dataNascimento.slice(0,10):""),$(t.responsavelNome||""),q(t.responsavelCpf?H(t.responsavelCpf):""),P(t.endereco||""),d(t.observacoes||""),x(t.ativo!==!1)):($(""),q(""),x(!0))},[t]);function a(){if(!N)return!1;const r=new Date(N+"T12:00:00");if(Number.isNaN(r.getTime()))return!1;const o=new Date;let s=o.getFullYear()-r.getFullYear();const i=o.getMonth()-r.getMonth();return(i<0||i===0&&o.getDate()<r.getDate())&&s--,s<18}function c(r){r.preventDefault(),C(""),R({}),k(!1);const o=a(),s=!p.trim(),i=!v.trim(),f=!!v.trim()&&!_(v),G=!!(g&&L(g).length>0&&!J(g)),W=!!(u&&L(u).length>0&&!J(u)),te=o&&(!j.trim()||!u.trim()||W);if(s||i||f||(o?W:G)||te){C("Preencha os campos obrigatórios."),k(!0);return}z(!0);const X={nome:p,email:v,telefone:L(B)||void 0,cpf:o?void 0:L(g)||void 0,dataNascimento:N||void 0,responsavelNome:o&&j.trim()||void 0,responsavelCpf:o&&L(u)||void 0,endereco:F||void 0,observacoes:T||void 0,ativo:M},Z=Y();(U?Z.put(`/alunos/${t.id}`,X):Z.post("/alunos",X)).then(()=>D()).catch(ne=>{const{mensagem:re,erros:oe}=ce(ne);C(re),R(oe)}).finally(()=>z(!1))}return e.jsx("div",{className:"modal-overlay",onClick:l,children:e.jsxs("div",{className:"modal",onClick:r=>r.stopPropagation(),children:[e.jsx("div",{className:"modal-header",children:e.jsx("h2",{children:h(U?"alunos.editStudent":"alunos.newStudentTitle")})}),e.jsxs("form",{onSubmit:c,className:"modal-body",children:[I&&e.jsx("div",{className:"alert alert-error",children:I}),e.jsxs("div",{className:`form-group ${y&&!p.trim()||S(m,"nome")?"field-error":""}`,children:[e.jsx("label",{children:"Nome *"}),e.jsx("input",{value:p,onChange:r=>w(r.target.value),required:!0}),S(m,"nome")&&e.jsx("span",{className:"field-error-msg",children:S(m,"nome")})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Data de nascimento"}),e.jsx("input",{type:"date",value:N,onChange:r=>O(r.target.value),placeholder:"DD/MM/AAAA"})]}),a()&&e.jsxs("div",{className:`form-group ${y&&!j.trim()?"field-error":""}`,children:[e.jsx("label",{children:"Nome do responsável *"}),e.jsx("input",{value:j,onChange:r=>$(r.target.value),placeholder:"Nome completo"}),S(m,"responsavelNome")&&e.jsx("span",{className:"field-error-msg",children:S(m,"responsavelNome")})]}),e.jsxs("div",{className:`form-group ${y&&(a()?responsavelCpfInvalido:g&&L(g).length>0&&!J(g))||S(m,a()?"responsavelCpf":"cpf")?"field-error":""}`,children:[e.jsx("label",{children:a()?"CPF do responsável *":"CPF"}),e.jsx("input",{value:a()?u:g,onChange:r=>a()?q(H(r.target.value)):E(H(r.target.value)),placeholder:"000.000.000-00",maxLength:14}),(S(m,"cpf")||S(m,"responsavelCpf"))&&e.jsx("span",{className:"field-error-msg",children:S(m,a()?"responsavelCpf":"cpf")})]}),e.jsxs("div",{className:`form-group ${y&&(!v.trim()||v.trim()&&!_(v))||S(m,"email")?"field-error":""}`,children:[e.jsx("label",{children:"E-mail *"}),e.jsx("input",{type:"email",value:v,onChange:r=>b(r.target.value),required:!0}),S(m,"email")&&e.jsx("span",{className:"field-error-msg",children:S(m,"email")})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Telefone"}),e.jsx("input",{value:B,onChange:r=>A(K(r.target.value)),placeholder:"(00) 00000-0000"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Endereço"}),e.jsx("input",{value:F,onChange:r=>P(r.target.value)})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Observações"}),e.jsx("textarea",{value:T,onChange:r=>d(r.target.value),rows:2})]}),e.jsxs("div",{className:"form-group form-group-status",children:[e.jsxs("div",{className:"status-ativo",children:[e.jsx("input",{type:"checkbox",id:"aluno-ativo",checked:M,onChange:r=>x(r.target.checked),className:"status-checkbox"}),e.jsx("label",{htmlFor:"aluno-ativo",className:"status-label",children:"Aluno ativo"})]}),e.jsx("p",{className:"form-hint",children:"Desmarque para marcar o aluno como inativo."})]})]}),e.jsxs("div",{className:"modal-footer",children:[e.jsx("button",{type:"button",className:"btn btn-outline",onClick:l,children:h("common.cancel")}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:c,disabled:V,children:h(V?"common.saving":"common.save")})]})]})})}const ue=["janeiro","fevereiro","março","abril","maio","junho","julho","agosto","setembro","outubro","novembro","dezembro"];function me({turmaId:t,matriculaId:l,alunoNome:D,ano:h,mes:p,onFechar:w}){const{t:v}=Q(),[b,B]=n.useState(h),[A,g]=n.useState(p),[E,N]=n.useState([]),[O,j]=n.useState(!0),[$,u]=n.useState(""),[q,F]=n.useState(null),[P,T]=n.useState(null),[d,M]=n.useState(0),[x,I]=n.useState(10);n.useEffect(()=>{B(h),g(p)},[h,p]);const C=n.useCallback(()=>{j(!0),u(""),N([]),Y().get(`/turmas/${t}/presencas/aluno/${l}`,{params:{ano:b,mes:A}}).then(a=>{const c=a.data,r=Array.isArray(c)?c:[];N(r.map(o=>({...o,dataAula:o.dataAula!=null?String(o.dataAula).slice(0,10):void 0})))}).catch(()=>u("Erro ao carregar presenças.")).finally(()=>j(!1))},[t,l,b,A]);n.useEffect(()=>{C()},[C]);function m(a){var s;const c=(s=a.dataAula)==null?void 0:s.slice(0,10);if(!c)return;const r=!a.presente,o=String(a.id??c);F(o),u(""),Y().post(`/turmas/${t}/presencas`,{dataAula:c,registros:[{matriculaId:l,presente:r}]}).then(()=>{N(i=>i.map(f=>f.id===a.id||f.dataAula===a.dataAula?{...f,presente:r}:f))}).catch(()=>u("Erro ao alterar presença.")).finally(()=>F(null))}function R(a,c){N(r=>r.map(o=>o.id===a.id||o.dataAula===a.dataAula?{...o,conteudoAula:c}:o))}function V(a){var o;const c=(o=a.dataAula)==null?void 0:o.slice(0,10);if(!c)return;const r=String(a.id??c);T(r),u(""),Y().post(`/turmas/${t}/presencas`,{dataAula:c,registros:[{matriculaId:l,presente:a.presente??!0,conteudoAula:(a.conteudoAula??"").trim()||void 0}]}).then(()=>{}).catch(()=>u("Erro ao atualizar conteúdo da aula.")).finally(()=>T(null))}const z=E.reduce((a,c)=>(c.presente?a.presenças+=1:a.faltas+=1,a),{presenças:0,faltas:0}),y=E.length,k=Math.max(1,Math.ceil(y/x)),U=n.useMemo(()=>E.slice(d*x,d*x+x),[E,d,x]);return n.useEffect(()=>{d>=k&&k>0&&M(0)},[d,k]),e.jsx("div",{className:"modal-overlay",onClick:w,children:e.jsxs("div",{className:"modal modal-presencas-aluno",onClick:a=>a.stopPropagation(),children:[e.jsx("div",{className:"modal-header",children:e.jsx("h2",{children:"Presenças e Faltas"})}),e.jsxs("div",{className:"modal-body",children:[$&&e.jsx("div",{className:"alert alert-error",children:$}),e.jsxs("div",{className:"form-row",style:{marginBottom:"1rem"},children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Mês"}),e.jsx(le,{value:String(A),onChange:a=>g(Number(a)||1),options:ue.map((a,c)=>({value:String(c+1),label:a})),placeholder:"Mês","aria-label":"Mês",className:"select-search-wrap--compact"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Ano"}),e.jsx("input",{type:"number",min:2020,max:2030,value:b,onChange:a=>B(Number(a.target.value))})]})]}),O?e.jsx("p",{children:"Carregando..."}):E.length===0?e.jsx("p",{className:"empty-state",children:"Nenhum registro de presença neste mês."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"presencas-resumo",children:[e.jsxs("span",{children:[e.jsx("strong",{children:"Presenças:"})," ",z.presenças]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Faltas:"})," ",z.faltas]})]}),e.jsx("p",{className:"form-hint",style:{marginBottom:"0.75rem"},children:"O conteúdo da aula é salvo automaticamente ao sair do campo (Tab ou clicar fora)."}),e.jsx("div",{className:"table-wrap",children:e.jsxs("table",{className:"table table-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Data"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Conteúdo da aula"}),e.jsx("th",{style:{width:"1%"}})]})}),e.jsx("tbody",{children:U.map(a=>{const c=String(a.id??a.dataAula??""),r=q===c;return e.jsxs("tr",{children:[e.jsx("td",{children:ae(a.dataAula)}),e.jsx("td",{children:e.jsx("span",{className:a.presente?"presenca-ok":"presenca-falta",children:a.presente?"Presença":"Falta"})}),e.jsxs("td",{children:[e.jsx("textarea",{className:"chamada-conteudo-field",value:a.conteudoAula??"",onChange:o=>R(a,o.target.value),onBlur:()=>V(a),disabled:P===c,placeholder:"Descreva o conteúdo ministrado nesta aula para o aluno...",rows:2,"aria-label":"Conteúdo da aula"}),P===c&&e.jsx("span",{className:"text-muted",style:{marginLeft:"0.5rem",display:"block",marginTop:"0.25rem"},children:"Salvando..."})]}),e.jsx("td",{children:e.jsx("button",{type:"button",className:"btn btn-outline btn-sm",onClick:()=>m(a),disabled:r,children:r?"Salvando...":a.presente?"Marcar Falta":"Marcar Presença"})})]},c)})})]})}),y>0&&e.jsx(se,{page:d,totalPages:k,totalElements:y,size:x,onPageChange:M,onSizeChange:a=>{I(a),M(0)}})]})]}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{type:"button",className:"btn btn-primary",onClick:w,children:v("common.close")})})]})})}function ee(t){const l=t.trim();return l.length?/^[\d.\s-]*$/.test(l)&&L(l).length>0:!1}function he(t){if(!t)return"";const l=new Date(t+"T12:00:00");if(Number.isNaN(l.getTime()))return"";const D=new Date;let h=D.getFullYear()-l.getFullYear();const p=D.getMonth()-l.getMonth();return(p<0||p===0&&D.getDate()<l.getDate())&&h--,h<18?"-18":"+18"}function ye(){const{t}=Q(),[l,D]=n.useState(null),[h,p]=n.useState(0),[w,v]=n.useState(10),[b,B]=n.useState(""),[A,g]=n.useState(""),[E,N]=n.useState(!0);n.useEffect(()=>{const s=setTimeout(()=>{B(A),p(0)},300);return()=>clearTimeout(s)},[A]);const[O,j]=n.useState(""),[$,u]=n.useState(!1),[q,F]=n.useState(null),[P,T]=n.useState(null),[d,M]=n.useState(null),[x,I]=n.useState(null),C=n.useCallback(()=>{N(!0);const s=new URLSearchParams({page:String(h),size:String(w)});b.trim()&&s.set("busca",ee(b)?L(b):b.trim()),Y().get(`/alunos?${s}`).then(i=>D(i.data)).catch(()=>j(t("common.errorLoading"))).finally(()=>N(!1))},[h,w,b]);n.useEffect(()=>C(),[C]);function m(){F(null),u(!0)}function R(s){F(s),u(!0)}function V(){u(!1),F(null),C()}const z=new Date,y=z.getFullYear(),k=z.getMonth()+1;async function U(s){j("");try{const{data:i}=await Y().get(`/matriculas/aluno/${s.id}`),f=(i??[]).filter(G=>G.ativo!==!1);if(f.length===0){j(t("alunos.noActiveEnrollment"));return}if(f.length===1){const G=f[0];M({turmaId:G.turmaId,matriculaId:G.id,alunoNome:s.nome,ano:y,mes:k});return}T({aluno:s,matriculas:f})}catch{j(t("alunos.errorLoadingEnrollments"))}}function a(){T(null)}function c(s){I(s)}function r(){x!=null&&Y().delete(`/alunos/${x}`).then(()=>{I(null),C()}).catch(s=>{var i,f;I(null),j(((f=(i=s==null?void 0:s.response)==null?void 0:i.data)==null?void 0:f.mensagem)||"Erro ao excluir.")})}const o=(l==null?void 0:l.content)??[];return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"page-header",children:[e.jsx("h1",{children:t("alunos.title")}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:m,children:"Novo aluno"})]}),O&&e.jsx("div",{className:"alert alert-error",children:O}),e.jsx("div",{className:"busca-wrap",children:e.jsx("input",{type:"search",placeholder:t("common.searchByNameOrCpf"),value:A,onChange:s=>{const i=s.target.value;g(ee(i)?H(i):i)},"aria-label":t("common.searchByNameOrCpf")})}),E?e.jsx("p",{children:t("common.loading")}):e.jsx("div",{className:"card",children:o.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("p",{children:t("alunos.noStudentFound")}),e.jsx("button",{type:"button",className:"btn btn-primary",onClick:m,children:t("alunos.registerStudent")})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"table-wrap",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nome"}),e.jsx("th",{children:"Telefone"}),e.jsx("th",{children:"Nascimento"}),e.jsx("th",{children:"Classificação"}),e.jsx("th",{children:"Ativo"}),e.jsx("th",{className:"actions-cell",children:"Ações"})]})}),e.jsx("tbody",{children:o.map(s=>{const i=he(s.dataNascimento);return e.jsxs("tr",{children:[e.jsx("td",{children:s.nome}),e.jsx("td",{children:s.telefone?K(s.telefone):"—"}),e.jsx("td",{children:ae(s.dataNascimento)}),e.jsxs("td",{children:[i==="-18"&&e.jsx("span",{className:"badge badge-danger",children:"-18"}),i==="+18"&&e.jsx("span",{className:"badge badge-success",children:"+18"}),!i&&"—"]}),e.jsx("td",{children:s.ativo!==!1?e.jsx("span",{className:"badge badge-success",children:"Sim"}):e.jsx("span",{className:"badge badge-danger",children:"Não"})}),e.jsxs("td",{className:"actions-cell",children:[e.jsx("button",{type:"button",className:"btn btn-outline",onClick:()=>U(s),children:"Ver presenças e faltas"}),e.jsx("button",{type:"button",className:"btn btn-outline",onClick:()=>R(s),children:t("common.edit")}),e.jsx("button",{type:"button",className:"btn btn-danger",onClick:()=>c(s.id),children:t("common.delete")})]})]},s.id)})})]})}),l&&l.totalPages>0&&e.jsx(se,{page:l.number,totalPages:l.totalPages,totalElements:l.totalElements,size:l.size,onPageChange:p,onSizeChange:s=>{v(s),p(0)}})]})}),$&&e.jsx(de,{aluno:q,onFechar:V,onSalvo:V}),P&&e.jsx("div",{className:"modal-overlay",onClick:a,children:e.jsxs("div",{className:"modal",onClick:s=>s.stopPropagation(),children:[e.jsx("div",{className:"modal-header",children:e.jsxs("h2",{children:["Presenças e faltas — ",P.aluno.nome]})}),e.jsxs("div",{className:"modal-body",children:[e.jsx("p",{className:"form-hint",children:"Selecione a turma para ver as presenças e faltas do aluno."}),e.jsx("ul",{className:"presencas-turmas-list",children:P.matriculas.map(s=>e.jsxs("li",{children:[e.jsx("span",{children:s.turmaDescricao??`Turma ${s.turmaId}`}),e.jsx("button",{type:"button",className:"btn btn-outline btn-sm",onClick:()=>{M({turmaId:s.turmaId,matriculaId:s.id,alunoNome:P.aluno.nome,ano:y,mes:k})},children:"Ver presenças e faltas"})]},s.id))})]}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{type:"button",className:"btn btn-outline",onClick:a,children:"Fechar"})})]})}),d&&e.jsx(me,{turmaId:d.turmaId,matriculaId:d.matriculaId,alunoNome:d.alunoNome,ano:d.ano,mes:d.mes,onFechar:()=>M(null)},`presenca-${d.turmaId}-${d.matriculaId}-${d.ano}-${d.mes}`),x!=null&&e.jsx(ie,{titulo:t("alunos.deleteStudent"),mensagem:t("alunos.deleteStudentConfirm"),confirmarTexto:t("common.delete"),cancelarTexto:t("common.cancel"),perigo:!0,onConfirmar:r,onCancelar:()=>I(null)})]})}export{ye as default};
